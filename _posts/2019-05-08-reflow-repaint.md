---
layout: post
title:  "回流和重绘"
date:   2019-05-08 11:51:54
categories: HTML CSS
tags: 回流 重绘
author: LpZ
---

本文将从浏览器的渲染过程开始详细讲解回流和重绘。(ps: 内容为学习摘录笔记)

## 浏览器的渲染过程
（渲染过程来自MDN）

![浏览器渲染过程](/image/浏览器渲染过程.png)

由上图，可以看到，浏览器渲染过程如下：
1. 解析HTML,生成DOM树，解析CSS,生成CSSOM树
2. 将DOM和CSSDOM树结合，生成render树
3. Layout/Reflow(回流)：根据生成的render树，进行回流，得到节点的几何信息（位置、大小等）
4. Raiting/Repaint(重绘)：根据渲染树以及回流得到的几何信息，得到节点的绝对像素
5. Display：将像素发给GPU，展示在页面上

下面通过图详细展示渲染过程的具体内容

### 生成渲染树

![渲染树](/image/浏览器渲染过程DOM.png)

为了构建渲染树，浏览器主要完成了以下工作：
1. 从DOM树的根节点开始遍历每个可见节点。
2. 对每个可见的节点，找到CSSOM树中对应的规则，并应用整合。
3. 根据每个可见节点以及其对应样式，组合生成渲染树

注意：第一点说到的可见节点，说明渲染树只包含可见节点。
那么不可见节点有哪些呢？不可见的节点包括：
- 一些通过CSS进行隐藏的节点。比如display: none(利用visibility和opacity隐藏的节点，还是会显示在渲染树上)
- 一些不会渲染输出的节点。比如script、meta、link等

## 什么是回流
当渲染树中的一部分或者全部因为元素的规模尺寸、布局、隐藏等改变而需要重新构建。这就称为回流。
每个页面至少需要回流一次，就是在页面第一次加载时，这时候一定会发生回流，因为要构建render tree。在回流时，浏览器会使渲染树中受影响的部分失效，并重新构造这部分渲染树，完成回流后，浏览器会重新绘制受影响的部分到屏幕，该过程称为重绘。

## 什么是重绘
当渲染树中的一些元素需要更新属性，而这些属性只是影响外观、风格，而不会影响布局的，比如：background-color，这时需要进行重绘。

## 对比
** 回流必将引起重绘，而重绘不一定会引起回流。
比如：
1. 只有颜色变化的时候就只会引起重绘而不会引起回流
2. 当页面布局和几何属性改变时，会引起回流（回流后，需要进行重绘）

## 扩展
### 回流和重绘会影响页面性能
根据改变的范围和程度，渲染树中或大或小的部分需要重新计算，有些改变会触发整个页面的重排，比如：滚动条的出现或者修改根节点
由于每次重排都会造成额外的计算消耗，因此大多数浏览器都会通过队列化修改并批量执行来优化重排过程。浏览器会将修改操作放到队列里，直到过一段时间或者操作达到了一个阈值，才清空队列，批量操作。
但是，当你获取布局信息的操作时，会强制队列flush，影响了浏览器的批处理回流优化机制。比如你访问一下属性或者使用以下方法：
- offsetTop、offsetLeft、offsetWidth、offsetHeight
- scrollTop、scrollLeft、scrollWidth、scrollHeight
- clientTop、clientLeft、clientWidth、clientHeight
- getComputedStyle()
- getBoundingClientRect()
- scrollIntoView()、scrollIntoViewIfNeeded()
- scrollTo()

### 避免回流和重绘
1. 不要经常访问会引起浏览器flush队列的属性（如果要使用，利用缓存）。
2. 避免设置多样内联样式。因为每一个都会造成回流，将样式合并在一个外部类中，通过class属性操作统一修改，只产生一个reflow。
3. 将需要多次回流的元素脱离文档流。脱离文档流的元素，在变化时不会影响到其他元素变化，所以可将该元素的position属性设为absolute或fixed。
4. 避免使用table布局。因为在布局建立之前，table需要很多关口，table是可以影响之前已经进入的DOM显示的元素，即使一些小的变化也会导致table中所有其他节点回流。
5. 对display属性为none的元素做操作，最后再显示出来，只产生一个回流。